<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0A0A0A">
    <title>Select Player - Gamex</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./styles/main.css">
    <style>
        .select-screen {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 2rem;
        }

        .select-container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .select-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .select-header h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .select-header p {
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .game-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .info-item {
            flex: 1;
        }

        .info-label {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2rem;
            color: var(--accent-friendship);
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.05);
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .player-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, transparent 0%, rgba(0, 0, 0, 0.3) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .player-card:hover {
            border-color: var(--accent-friendship);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 215, 64, 0.3);
        }

        .player-card:hover::before {
            opacity: 1;
        }

        .player-card.selected {
            border-color: var(--accent-love);
            background: linear-gradient(135deg, rgba(255, 23, 68, 0.1), rgba(213, 0, 249, 0.1));
            box-shadow: 0 0 40px rgba(255, 23, 68, 0.4);
        }

        .player-avatar {
            font-size: 4rem;
            margin-bottom: 1rem;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
        }

        .player-name {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .player-number {
            font-size: 0.9rem;
            opacity: 0.6;
        }

        .selected-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--accent-love);
            color: #fff;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(255, 23, 68, 0.5);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .back-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 1.2rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            color: var(--neutral-text);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            border-color: var(--accent-friendship);
            background: rgba(255, 215, 64, 0.1);
        }

        .watch-btn {
            flex: 2;
            background: linear-gradient(135deg, rgba(255, 23, 68, 0.8), rgba(213, 0, 249, 0.8));
            border: 2px solid var(--accent-love);
            border-radius: 15px;
            padding: 1.2rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 30px rgba(255, 23, 68, 0.4);
        }

        .watch-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 40px rgba(255, 23, 68, 0.6);
        }

        .watch-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="select-screen">
        <canvas id="auraCanvas"></canvas>

        <div class="select-container">
            <div class="select-header">
                <h2>SELECT YOUR PLAYER</h2>
                <p>Choose which player's perspective you want to follow</p>
            </div>

            <div class="game-info">
                <div class="info-item">
                    <div class="info-label">Players</div>
                    <div class="info-value" id="playerCountInfo">2</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Difficulty</div>
                    <div class="info-value" id="difficultyInfo">HARD</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Min Rounds</div>
                    <div class="info-value" id="roundsInfo">8</div>
                </div>
            </div>

            <div class="players-grid" id="playersGrid">
                <!-- Players will be added dynamically -->
            </div>

            <div class="action-buttons">
                <button class="back-btn" id="backBtn">
                    ← BACK
                </button>
                <button class="watch-btn" id="watchBtn" disabled>
                    WATCH GAME
                </button>
            </div>
        </div>
    </div>

    <script src="./js/audio.js"></script>
    <script src="./js/animations.js"></script>
    <script>
        const audio = new GameAudio();
        const canvas = document.getElementById('auraCanvas');
        const animations = new AuraAnimations(canvas);
        animations.startAmbientAura();

        // Load game config
        let gameConfig = JSON.parse(sessionStorage.getItem('gameConfig'));
        if (!gameConfig) {
            window.location.href = './config.html';
        }

        let selectedPlayerId = null;

        // Add avatar image styling
        const style = document.createElement('style');
        style.textContent = `
            .player-avatar {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                margin: 0 auto 1rem;
                object-fit: cover;
                border: 3px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            }

            .player-card.selected .player-avatar {
                border-color: var(--accent-love);
                box-shadow: 0 0 20px rgba(255, 23, 68, 0.6);
            }

            .gender-badge {
                display: inline-block;
                padding: 0.25rem 0.75rem;
                border-radius: 12px;
                font-size: 0.7rem;
                margin-top: 0.5rem;
                opacity: 0.7;
            }

            .gender-badge.male {
                background: rgba(33, 150, 243, 0.2);
                color: #64B5F6;
            }

            .gender-badge.female {
                background: rgba(233, 30, 99, 0.2);
                color: #F48FB1;
            }
        `;
        document.head.appendChild(style);

        // Display game info
        document.getElementById('playerCountInfo').textContent = gameConfig.playerCount;
        document.getElementById('difficultyInfo').textContent = gameConfig.difficultyName;
        document.getElementById('roundsInfo').textContent = gameConfig.minRounds;

        // Generate player cards
        function generatePlayerCards() {
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';

            console.log('Game config:', gameConfig);
            console.log('Players:', gameConfig.players);

            if (!gameConfig.players || gameConfig.players.length === 0) {
                grid.innerHTML = '<p style="color: red;">No players found! Please go back and try again.</p>';
                return;
            }

            gameConfig.players.forEach((player, index) => {
                console.log(`Player ${index}:`, player);

                const card = document.createElement('div');
                card.className = 'player-card';
                card.dataset.playerId = player.id;

                // Fallback avatar if URL is undefined
                const playerGender = player.gender || 'male';
                const avatarStyle = playerGender === 'male' ? 'adventurer' : 'lorelei';
                const avatarUrl = player.avatar || `https://api.dicebear.com/7.x/${avatarStyle}/svg?seed=${player.name || 'player' + index}`;
                const playerName = player.name || `Player ${player.number || index + 1}`;
                const genderSymbol = playerGender === 'male' ? '♂' : '♀';

                card.innerHTML = `
                    <img src="${avatarUrl}" alt="${playerName}" class="player-avatar"
                         onerror="console.error('Failed to load avatar:', this.src); this.src='https://api.dicebear.com/7.x/${avatarStyle}/svg?seed=${playerName}${Date.now()}';" />
                    <div class="player-name">${playerName}</div>
                    <div class="player-number">Player ${player.number}</div>
                    <div class="gender-badge ${playerGender}">${genderSymbol}</div>
                `;

                card.addEventListener('click', () => selectPlayer(player.id, card));

                grid.appendChild(card);
            });
        }

        // Select player
        function selectPlayer(playerId, cardElement) {
            selectedPlayerId = playerId;

            // Remove selected class from all cards
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.remove('selected');
                const badge = card.querySelector('.selected-badge');
                if (badge) badge.remove();
            });

            // Add selected class to clicked card
            cardElement.classList.add('selected');

            // Add selected badge
            const badge = document.createElement('div');
            badge.className = 'selected-badge';
            badge.textContent = 'WATCHING';
            cardElement.appendChild(badge);

            // Enable watch button
            document.getElementById('watchBtn').disabled = false;

            audio.playSound('chime');
            if (navigator.vibrate) navigator.vibrate([10, 50, 10]);
        }

        // Back button
        document.getElementById('backBtn').addEventListener('click', () => {
            audio.playSound('chime');
            window.location.href = './config.html';
        });

        // Watch button
        document.getElementById('watchBtn').addEventListener('click', () => {
            if (!selectedPlayerId) return;

            // Save selected player to config
            gameConfig.watchingPlayerId = selectedPlayerId;
            gameConfig.watchingPlayer = gameConfig.players.find(p => p.id === selectedPlayerId);

            sessionStorage.setItem('gameConfig', JSON.stringify(gameConfig));

            audio.playSound('chime');
            if (navigator.vibrate) navigator.vibrate([20, 50, 20]);

            setTimeout(() => {
                window.location.href = './autoplay.html';
            }, 300);
        });

        // Haptic feedback
        document.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('touchstart', () => {
                if (navigator.vibrate && !btn.disabled) {
                    navigator.vibrate(10);
                }
            });
        });

        // Initialize
        generatePlayerCards();
    </script>
</body>
</html>
