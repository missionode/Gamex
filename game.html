<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0A0A0A">
    <title>Playing - Gamex</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./styles/main.css">
</head>
<body>
    <div class="game-screen">
        <canvas id="auraCanvas"></canvas>

        <div class="content">
            <div class="game-header">
                <div class="round-counter">
                    Round <span id="currentRound">1</span> / <span id="totalRounds">8</span>
                </div>
                <div class="current-player" id="currentPlayerText">
                    Your turn
                </div>
            </div>

            <!-- Emotion Choices (shown when it's player's turn) -->
            <div class="emotion-choices" id="emotionChoices">
                <button class="emotion-btn love" data-emotion="love">
                    <div class="emotion-icon">‚ù§Ô∏è</div>
                    <div class="emotion-info">
                        <h3>Love</h3>
                        <p>Desire for connection and care.</p>
                    </div>
                </button>

                <button class="emotion-btn friendship" data-emotion="friendship">
                    <div class="emotion-icon">üíõ</div>
                    <div class="emotion-info">
                        <h3>Friendship</h3>
                        <p>Trust and stability.</p>
                    </div>
                </button>

                <button class="emotion-btn sex" data-emotion="sex">
                    <div class="emotion-icon">üíú</div>
                    <div class="emotion-info">
                        <h3>Sex</h3>
                        <p>Attraction and instinct.</p>
                    </div>
                </button>
            </div>

            <!-- Waiting State (shown when it's another player's turn) -->
            <div class="waiting-state hidden" id="waitingState">
                <h3>Awaiting player's choice...</h3>
                <div class="spinner"></div>
                <p id="waitingPlayerText">Player 2 is choosing...</p>
            </div>
        </div>
    </div>

    <script src="./js/audio.js"></script>
    <script src="./js/animations.js"></script>
    <script src="./js/game-logic.js"></script>
    <script>
        const audio = new GameAudio();
        const canvas = document.getElementById('auraCanvas');
        const animations = new AuraAnimations(canvas);
        const gameLogic = new GameLogic();

        // Load game state
        let gameState = JSON.parse(sessionStorage.getItem('gameState'));
        if (!gameState) {
            window.location.href = './lobby.html';
        }

        const localPlayer = gameState.players.find(p => p.isLocal);
        let turnsCompleted = 0;

        // Update UI
        function updateUI() {
            document.getElementById('currentRound').textContent =
                Math.floor(turnsCompleted / gameState.players.length) + 1;
            document.getElementById('totalRounds').textContent = gameState.totalRounds;

            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const isLocalTurn = currentPlayer.isLocal;

            if (isLocalTurn) {
                // Show choices
                document.getElementById('emotionChoices').classList.remove('hidden');
                document.getElementById('waitingState').classList.add('hidden');
                document.getElementById('currentPlayerText').textContent = 'Your turn';
                animations.setAuraType('ambient');
            } else {
                // Show waiting state
                document.getElementById('emotionChoices').classList.add('hidden');
                document.getElementById('waitingState').classList.remove('hidden');
                document.getElementById('currentPlayerText').textContent = `${currentPlayer.name}'s turn`;
                document.getElementById('waitingPlayerText').textContent =
                    `${currentPlayer.name} is choosing...`;
                animations.setAuraType('waiting');

                // Simulate AI choice for other players (in production, this comes via Bluetooth)
                setTimeout(() => {
                    const aiChoices = ['love', 'friendship', 'sex'];
                    const randomChoice = aiChoices[Math.floor(Math.random() * aiChoices.length)];
                    handleChoice(randomChoice, currentPlayer);
                }, 2000);
            }
        }

        // Handle emotion choice
        function handleChoice(emotion, player) {
            const choice = {
                playerId: player.id,
                playerName: player.name,
                emotion: emotion,
                round: Math.floor(turnsCompleted / gameState.players.length) + 1,
                turn: turnsCompleted + 1
            };

            gameState.choices.push(choice);

            // Update averages
            gameLogic.updateAverages(gameState);

            // Play feedback
            audio.playSound(emotion);
            animations.playEmotionAnimation(emotion);
            if (navigator.vibrate) {
                navigator.vibrate(emotion === 'love' ? 20 : emotion === 'friendship' ? [10, 10, 10] : 30);
            }

            // Move to next turn
            turnsCompleted++;
            gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;

            // Check if game should end
            const minRoundsCompleted = Math.floor(turnsCompleted / gameState.players.length);

            if (minRoundsCompleted >= gameState.totalRounds) {
                // Game over - check for bingo
                sessionStorage.setItem('gameState', JSON.stringify(gameState));

                setTimeout(() => {
                    const result = gameLogic.checkBingo(gameState);
                    if (result.isBingo) {
                        animations.playBingoAnimation();
                        audio.playSound('bingo');
                        if (navigator.vibrate) navigator.vibrate([50, 100, 50]);
                    } else {
                        audio.playSound('replay');
                        if (navigator.vibrate) navigator.vibrate(200);
                    }

                    setTimeout(() => {
                        window.location.href = './results.html';
                    }, 2000);
                }, 1000);
            } else {
                // Continue game
                sessionStorage.setItem('gameState', JSON.stringify(gameState));
                setTimeout(updateUI, 1500);
            }
        }

        // Emotion button handlers
        document.querySelectorAll('.emotion-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const emotion = this.dataset.emotion;
                const currentPlayer = gameState.players[gameState.currentPlayerIndex];

                if (!currentPlayer.isLocal) return;

                // Disable all buttons
                document.querySelectorAll('.emotion-btn').forEach(b => b.disabled = true);

                handleChoice(emotion, currentPlayer);
            });

            // Haptic feedback
            btn.addEventListener('touchstart', () => {
                if (navigator.vibrate && !btn.disabled) {
                    navigator.vibrate(10);
                }
            });
        });

        // Initialize
        animations.startAmbientAura();
        updateUI();
    </script>
</body>
</html>
